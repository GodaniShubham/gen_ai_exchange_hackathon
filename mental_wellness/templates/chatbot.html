{% extends "base.html" %}
{% block content %}

<!-- Offline Banner -->
<div id="offlineBanner" class="hidden fixed top-0 left-0 w-full bg-red-700 text-white py-3 flex items-center justify-center gap-3 shadow-xl z-50">
  <i class="fas fa-wifi-slash fa-lg"></i>
  <span class="font-semibold text-sm md:text-base">🔴 You are offline. Some features may not work.</span>
</div>

<div class="h-[90vh] flex bg-gray-950 text-white font-[system-ui]">

 <!-- 📜 Sidebar / History -->
<div class="w-64 bg-black/90 border-r border-gray-800 flex flex-col">
  <div class="p-4 flex items-center justify-end border-b border-gray-800">
    <button onclick="newChat()" 
            class="px-3 py-1 text-sm font-semibold rounded-md bg-gradient-to-r from-green-400 to-teal-500 hover:from-teal-500 hover:to-green-400 transition shadow-lg">
      + New
    </button>
  </div>

 
<!-- Sidebar Buttons -->
<div class="flex flex-col p-2 space-y-2 border-b border-gray-800">
  <a href="{% url 'selfcare' %}" class="w-full text-sm px-3 py-2 rounded-xl bg-gray-800 hover:bg-green-600 transition shadow-md text-center">Self Care Guides</a>

  <a href="{% url 'analysis' %}" class="w-full text-sm px-3 py-2 rounded-xl bg-gray-800 hover:bg-green-600 transition shadow-md text-center">Mood Analytics</a>

 <a href="{% url 'journals:journal_page' %}" 
   class="w-full text-sm px-3 py-2 rounded-xl bg-gray-800 hover:bg-green-600 transition shadow-md text-center">
   Journal
</a>


  <a href="{% url 'settings_privacy' %}" class="w-full text-sm px-3 py-2 rounded-xl bg-gray-800 hover:bg-green-600 transition shadow-md text-center">⚙ Settings & Privacy</a>

  <button onclick="downloadChat()" class="w-full text-sm px-3 py-2 rounded-xl bg-gray-800 hover:bg-green-600 transition shadow-md">⬇ Export Chat</button>
</div>


<!-- Chat History -->
<div id="chat_history" class="flex-1 overflow-y-auto p-3 space-y-2 text-sm scrollbar-thin scrollbar-thumb-gray-700">
  <div class="text-gray-500 italic">No chats yet...</div>
</div>


  <div class="p-3 border-t border-gray-800 text-xs text-gray-400">
    <button onclick="clearHistory()" class="hover:text-red-400">🗑 Clear all</button>
  </div>
</div>


  <!-- 💬 Main Chat Area -->
  <div class="flex-1 flex flex-col">
    
    <!-- Header -->
    <div class="p-4 border-b border-gray-800 bg-black/80 backdrop-blur-lg flex justify-between items-center">
      <h1 class="text-xl font-bold bg-gradient-to-r from-green-400 to-teal-500 bg-clip-text text-transparent">
        💬 Chat with Saharathi AI
      </h1>

      <!-- 🎙️ Voice Controls -->
      <div class="flex items-center gap-2 text-sm">
        <span class="text-gray-400">Voice:</span>
        <button onclick="setVoice('male')" id="maleBtn" class="px-2 py-1 rounded-md bg-gray-800 hover:bg-green-600 transition">👨 Male</button>
        <button onclick="setVoice('female')" id="femaleBtn" class="px-2 py-1 rounded-md bg-gray-800 hover:bg-green-600 transition">👩 Female</button>
        <button onclick="speakBotReply()" class="px-3 py-1 rounded-md bg-green-600 hover:bg-green-700 transition">🔊 Speak</button>
      </div>
    </div>

    <!-- 🌱 Daily Tip Widget -->
    <div id="daily_tip" class="p-3 text-sm bg-gradient-to-r from-green-500 to-teal-600 text-white text-center">
      🌱 Daily Tip: Stay hydrated and take deep breaths!
    </div>

<!-- 🌈 Mood Selector -->
<div class="flex gap-3 p-4 bg-black/70 border-b border-gray-700 text-sm text-gray-300 items-center">
  <span class="font-semibold">How are you feeling today?</span>
  <div class="flex gap-2" id="moodButtons">
    <button onclick="setMood('😊 Happy')" id="mood_happy" 
      class="px-3 py-1 rounded-full bg-gray-700 hover:scale-110 hover:bg-green-600 transition-all shadow-md">😊 Happy</button>
    <button onclick="setMood('😟 Stressed')" id="mood_stressed" 
      class="px-3 py-1 rounded-full bg-gray-700 hover:scale-110 hover:bg-green-600 transition-all shadow-md">😟 Stressed</button>
    <button onclick="setMood('😔 Sad')" id="mood_sad" 
      class="px-3 py-1 rounded-full bg-gray-700 hover:scale-110 hover:bg-green-600 transition-all shadow-md">😔 Sad</button>
    <button onclick="setMood('😐 Neutral')" id="mood_neutral" 
      class="px-3 py-1 rounded-full bg-gray-700 hover:scale-110 hover:bg-green-600 transition-all shadow-md">😐 Neutral</button>
  </div>
  <span id="selectedMood" class="ml-3 text-green-400 italic"></span>
</div>


    <!-- Chat Window -->
    <div id="chat_area" 
         class="flex-1 overflow-y-auto p-6 space-y-4 scroll-smooth bg-gray-900/60">
      <div class="text-center text-gray-500 italic">👋 Start a conversation...</div>
    </div>

      <!-- 🆕 Smart Suggestions -->
    <div id="suggestions" class="flex flex-wrap gap-2 px-6 pb-2"></div>

    <!-- Typing Indicator -->
    <div id="typing" class="hidden px-6 pb-2 text-gray-400 italic flex gap-2 items-center">
      <span class="dot w-2 h-2 bg-green-400 rounded-full animate-bounce"></span>
      <span class="dot w-2 h-2 bg-green-400 rounded-full animate-bounce delay-200"></span>
      <span class="dot w-2 h-2 bg-green-400 rounded-full animate-bounce delay-400"></span>
      <span>Typing...</span>
    </div>

    <!-- Input Box -->
    <div class="p-4 border-t border-gray-800 bg-black/80 backdrop-blur-lg space-y-3">

      <!-- Quick Suggestions -->
      <div class="flex gap-2">
        <button onclick="sendQuick('I feel stressed')" class="px-3 py-1 bg-gray-800 hover:bg-green-600 rounded-full text-sm">I feel stressed</button>
        <button onclick="sendQuick('Give me meditation tips')" class="px-3 py-1 bg-gray-800 hover:bg-green-600 rounded-full text-sm">Meditation Tips</button>
        <button onclick="sendQuick('Help me with sleep')" class="px-3 py-1 bg-gray-800 hover:bg-green-600 rounded-full text-sm">Sleep Help</button>
      </div>

      <div class="flex items-center gap-3 bg-gray-900 px-4 py-2 rounded-2xl border border-gray-700 shadow-inner">

        <!-- File -->
        <label for="file_input" class="cursor-pointer text-gray-400 hover:text-green-400 transition">
          <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="file_input" class="hidden" />

        <!-- Mic 🎤 -->
        <button onclick="startVoice()" class="text-gray-400 hover:text-green-400 transition">
          <i class="fas fa-microphone"></i>
        </button>

        <!-- Text -->
        <input type="text" id="user_input"
               class="flex-grow bg-transparent outline-none px-2 text-white placeholder-gray-500"
               placeholder="Type your message..." />

        <!-- Send -->
        <button onclick="sendMessage()" 
                class="p-2 rounded-full bg-green-600 hover:bg-green-700 transition">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script>

  // 🌐 Offline / Online Detection
window.addEventListener("online", () => {
  const banner = document.getElementById("offlineBanner");
  banner.classList.remove("show");
  banner.classList.add("hidden");
  renderMessages([{sender:"bot", text:"🟢 You are back online!"}], true);
});

window.addEventListener("offline", () => {
  const banner = document.getElementById("offlineBanner");
  banner.classList.remove("hidden");
  banner.classList.add("show");
  renderMessages([{sender:"bot", text:"🔴 You went offline. Don’t worry, I’ll save your thoughts until we reconnect."}], true);
});

// 🆕 Predefined Suggestion Responses
const suggestionResponses = {
  "Any quick stress relief tips?": "😌 Quick Tip: Take a short walk, stretch, or close your eyes and breathe deeply 5 times to reset your mind.",
  "Guide me for breathing exercise": "🌬️ Breathing Exercise: Sit comfortably, inhale deeply for 4 counts, hold for 4 counts, exhale slowly for 6 counts. Repeat 5 times and notice your stress melting away.",
  "How to sleep faster?": "🌙 Try: Dim lights, avoid screens, do 4-7-8 breathing, and relax each body part gradually.",
  "Tell me a bedtime meditation": "🧘‍♂️ Bedtime Meditation: Sit or lie down, focus on your breath, slowly release tension from head to toe for 5 minutes.",
  "Motivate me 🙏": "💪 Remember: You’ve overcome challenges before. Take a deep breath and tackle one thing at a time.",
  "Any self-care tips?": "🛁 Self-care tip: Take a warm shower, drink water, journal your thoughts, or do something you enjoy for 15 minutes."
};

// Modified sendSuggestionMessage to use predefined responses
function sendSuggestionMessage(message){
  renderMessages([{sender:"user", text:message}], true);

  // Clear old suggestions
  document.getElementById("suggestions").innerHTML = "";

  document.getElementById("user_input").value = message;

  // If predefined response exists, show it instantly
  if(suggestionResponses[message]){
    renderMessages([{sender:"bot", text:suggestionResponses[message]}], true);
    lastBotReply = suggestionResponses[message]; // for voice
  } else {
    // fallback to normal API call
    sendMessage(true); // bypass allowedTopics
  }
}


let currentChatId = null;
let userMood = "😐 Neutral";  
let synth = window.speechSynthesis;
let lastBotReply = "";
let selectedVoice = "male"; // default
let voices = [];

// 🔊 Load Voices (browser se)
function loadVoices(){
  voices = synth.getVoices();
}
window.speechSynthesis.onvoiceschanged = loadVoices;

// 🟢 Step 1: First-time Welcome Message
document.addEventListener("DOMContentLoaded", function() {
  if (!localStorage.getItem("visitedBefore")) {
    setTimeout(() => {
      renderMessages([
        {
          sender: "bot",
          text: "👋 Welcome! I’m Saharathi AI 🌱 I can help you with stress, sleep, meditation and mental wellness. How are you feeling today?"
        }
      ], true);
    }, 800); // thoda delay taki UI load ho jaye

    localStorage.setItem("visitedBefore", "yes");
  }
});

// 🟢 Step 2: Download Chat History
function downloadChat() {
  const chatText = document.getElementById("chat_area").innerText;
  if (!chatText.trim()) {
    alert("⚠️ No chat available to export!");
    return;
  }

  const blob = new Blob([chatText], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "chat_history.txt";
  link.click();
}


// 💡 Smart Suggestions
function showSuggestions(userMessage){
  const suggestionBox = document.getElementById("suggestions");
  suggestionBox.innerHTML = ""; // clear old

  let suggestions = [];
  if (userMessage.includes("stress")) {
    suggestions = ["Any quick stress relief tips?", "Guide me for breathing exercise"];
  } else if (userMessage.includes("sleep")) {
    suggestions = ["How to sleep faster?", "Tell me a bedtime meditation"];
  } else if (userMessage.includes("sad") || userMessage.includes("depress")) {
    suggestions = ["Motivate me 🙏", "Any self-care tips?"];
  } else {
    suggestions = ["Give me a tip", "Suggest meditation", "Show mood analytics"];
  }

  suggestions.forEach(sug => {
    const btn = document.createElement("button");
    btn.className = "px-3 py-1 m-1 rounded-lg bg-gray-700 hover:bg-green-600 transition";
    btn.innerText = sug;
    btn.onclick = () => sendSuggestionMessage(sug); // NEW function
    suggestionBox.appendChild(btn);
  });
}

// Modified sendSuggestionMessage
function sendSuggestionMessage(message){
  // Render user message
  renderMessages([{sender:"user", text:message}], true);

  // Clear old suggestions
  document.getElementById("suggestions").innerHTML = "";

  // Set user input (optional)
  document.getElementById("user_input").value = message;

  // Send the message to bot API
  sendMessage(true); // pass true to bypass allowedTopics
}

// Updated sendMessage function to handle suggestions
async function sendMessage(isSuggestion=false) {
  const inputEl = document.getElementById("user_input");
  const userMessage = inputEl.value.trim();
  if (!userMessage) return;

  renderMessages([{sender:"user", text:userMessage}], true);
  inputEl.value = "";
  document.getElementById("typing").classList.remove("hidden");

  if (!isSuggestion) { // only block normal user messages
    const isAllowed = allowedTopics.some(topic => 
      userMessage.toLowerCase().includes(topic)
    );
    if (!isAllowed) {
      document.getElementById("typing").classList.add("hidden");
      renderMessages([{sender:"bot", text:"⚠️ I only respond to mental health, mood, or wellness questions."}], true);
      return;
    }
  }

  // ...rest of your existing API call code
}



// ✅ Voice Select Button
function setVoice(type){
  selectedVoice = type;
  document.getElementById("maleBtn").classList.remove("bg-green-600");
  document.getElementById("femaleBtn").classList.remove("bg-green-600");
  if(type==="male") document.getElementById("maleBtn").classList.add("bg-green-600");
  else document.getElementById("femaleBtn").classList.add("bg-green-600");
}

// ✅ Mood Selector
function setMood(mood){
  userMood = mood;

  document.querySelectorAll("#moodButtons button").forEach(btn => {
    btn.classList.remove("bg-green-600");
    btn.classList.add("bg-gray-700");
  });

  if (mood.includes("Happy")) document.getElementById("mood_happy").classList.add("bg-green-600");
  if (mood.includes("Stressed")) document.getElementById("mood_stressed").classList.add("bg-green-600");
  if (mood.includes("Sad")) document.getElementById("mood_sad").classList.add("bg-green-600");
  if (mood.includes("Neutral")) document.getElementById("mood_neutral").classList.add("bg-green-600");

  document.getElementById("selectedMood").innerText = `Selected: ${mood}`;
}

// ✅ Daily Tips
const tips = [
  "🌱 Drink at least 8 glasses of water.",
  "🧘 Practice meditation for 5 mins daily.",
  "😴 Get 7-8 hours of quality sleep.",
  "🚶 Take a 15-minute walk outdoors."
];
let i=0;
setInterval(()=>{
  document.getElementById("daily_tip").innerText = tips[i];
  i = (i+1) % tips.length;
}, 5000);

// ✅ CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

// 🆕 Allowed mental-health-related topics
const allowedTopics = [
  "stress", "anxiety", "sleep", "mood", "depression",
  "self care", "meditation", "wellness", "focus", "relax",
  "happy", "sad", "tired", "mental health"
];

// 🆕 Create new chat
function newChat(){
  currentChatId = null;
  document.getElementById("chat_area").innerHTML = `<div class="text-center text-gray-500 italic">🆕 New conversation...</div>`;
}

// 📥 Load messages
async function loadChat(id, title){
  currentChatId = id;
  try {
    const resp = await fetch(`/get_chat_messages/${id}/`);
    const data = await resp.json();
    renderMessages(data.messages || []);
  } catch(err){
    console.error(err);
  }
}

// 📤 Send Message
async function sendMessage() {
  const inputEl = document.getElementById("user_input");
  const userMessage = inputEl.value.trim();
  if (!userMessage) return;

  renderMessages([{sender:"user", text:userMessage}], true);
  inputEl.value = "";
  document.getElementById("typing").classList.remove("hidden");

  const isAllowed = allowedTopics.some(topic => 
    userMessage.toLowerCase().includes(topic)
  );

  if (!isAllowed) {
    document.getElementById("typing").classList.add("hidden");
    renderMessages([{sender:"bot", text:"⚠️ I only respond to mental health, mood, or wellness questions."}], true);
    return;
  }

  try {
    const resp = await fetch("/chatbot_api/", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: new URLSearchParams({
        message: userMessage,
        mood: userMood,
        session_id: currentChatId || ""
      })
    });

    const data = await resp.json();
    currentChatId = data.session_id;
    document.getElementById("typing").classList.add("hidden");

    renderMessages([{sender:"bot", text:data.reply}], true);
    showSuggestions(userMessage);

    if (!document.getElementById("chat_item_"+currentChatId)){
      const historyBox = document.getElementById("chat_history");
      if (historyBox.innerText.includes("No chats yet")) historyBox.innerHTML = "";
      historyBox.innerHTML = `<div onclick="loadChat('${currentChatId}', '${data.title}')"
                               id="chat_item_${currentChatId}"
                               class="p-2 rounded-md hover:bg-gray-800 cursor-pointer">${data.title}</div>` + historyBox.innerHTML;
    }
  } catch (err) {
    console.error("⚠️ Network error / offline mode:", err);
    document.getElementById("typing").classList.add("hidden");

    // 🆕 Offline fallback reply
    renderMessages([{
      sender: "bot",
      text: "🌐 It looks like you are offline. Don’t worry, I’m still here for you 💚. Try some deep breathing or write your thoughts in the journal until we reconnect."
    }], true);

    // Smart suggestions even offline
    showSuggestions(userMessage);
  }
}





// 💬 Render messages
function renderMessages(messages, append=false){
  const chatBox = document.getElementById("chat_area");
  if (!append) chatBox.innerHTML = "";
  messages.forEach(msg => {
    if (msg.sender === "user") {
      chatBox.innerHTML += `<div class="flex justify-end"><div class="px-4 py-2 rounded-2xl bg-green-600 text-white max-w-md">${msg.text}</div></div>`;
    } else {
      lastBotReply = msg.text;
      chatBox.innerHTML += `<div class="flex justify-start"><div class="px-4 py-2 rounded-2xl bot-bubble">${msg.text}</div></div>`;
    }
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ✅ Voice Reply
let isSpeaking = false;
function speakBotReply(){
  if (!lastBotReply) return;

  if (isSpeaking && synth.speaking) {
    synth.cancel();
    isSpeaking = false;
    return;
  }

  if (synth.speaking) synth.cancel();
  const utterance = new SpeechSynthesisUtterance(lastBotReply);
  utterance.lang = "en-US";

  if (voices.length > 0) {
    let voice = null;
    if (selectedVoice === "male") {
      voice = voices.find(v => v.name.toLowerCase().includes("male")) || voices[0];
    } else {
      voice = voices.find(v => v.name.toLowerCase().includes("female")) || voices[voices.length - 1];
    }
    utterance.voice = voice;
  }

  utterance.onstart = () => { isSpeaking = true; };
  utterance.onend = () => { isSpeaking = false; };
  synth.speak(utterance);
}

// ✅ Voice Input 🎤
function startVoice(){
  if (!('webkitSpeechRecognition' in window)) {
    alert("❌ Voice recognition not supported in this browser.");
    return;
  }
  const recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US"; 
  recognition.start();

  recognition.onresult = function(event){
    let transcript = event.results[0][0].transcript;

    // ✅ Check allowed topic
    const isAllowed = allowedTopics.some(topic => transcript.toLowerCase().includes(topic));
    if (!isAllowed) {
      renderMessages([{sender:"bot", text:"⚠️ I can only respond to mental health, mood, or wellness related questions."}], true);
      return;
    }

    document.getElementById("user_input").value = transcript;
    sendMessage();
  };
}

// 🗑 Clear All
function clearHistory(){
  document.getElementById("chat_history").innerHTML = `<div class="text-gray-500 italic">No chats yet...</div>`;
  document.getElementById("chat_area").innerHTML = `<div class="text-center text-gray-500 italic">👋 Start a conversation...</div>`;
  currentChatId = null;
}

document.getElementById("user_input").addEventListener("keypress", function (e) {
  if (e.key === "Enter") sendMessage();
});

// ✅ Quick buttons
function sendQuick(msg){
  // ✅ Check allowed topic
  const isAllowed = allowedTopics.some(topic => msg.toLowerCase().includes(topic));
  if (!isAllowed) {
    renderMessages([{sender:"bot", text:"⚠️ I can only respond to mental health, mood, or wellness related questions."}], true);
    return;
  }
  document.getElementById("user_input").value = msg;
  sendMessage();
}

// ✅ Top buttons
function openGuide() { alert("Self Care Guides clicked!"); }
function openMoodAnalytics() { alert("Mood Analytics clicked!"); }
function openJournal() { alert("Journal clicked!"); }
function openSettings() { alert("⚙ Settings & Privacy clicked!"); }

</script>

<!-- Styles -->
<style>
/* ===== Bot Bubble ===== */
.bot-bubble {
  background: linear-gradient(135deg, #1f4037, #99f2c8);
  color: white;
  border-radius: 25px;
  padding: 14px 18px;
  max-width: 75%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  word-wrap: break-word;
  font-size: 0.95rem;
  line-height: 1.4;
  transition: transform 0.2s;
}
.bot-bubble:hover {
  transform: translateY(-2px);
}

/* ===== User Bubble ===== */
.user-bubble {
  background: linear-gradient(135deg, #38ef7d, #11998e);
  color: white;
  border-radius: 25px;
  padding: 14px 18px;
  max-width: 75%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  word-wrap: break-word;
  font-size: 0.95rem;
  line-height: 1.4;
  transition: transform 0.2s;
}
.user-bubble:hover {
  transform: translateY(-2px);
}

/* ===== Typing Indicator ===== */
.dot {
  display: inline-block;
}

/* Chat Bot typing animation */
.typing-bubble {
  display: inline-flex;
  gap: 4px;
  background: rgba(50,50,50,0.8);
  border-radius: 15px;
  padding: 8px 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.typing-bubble span {
  width: 8px;
  height: 8px;
  background: #66ffcc;
  border-radius: 50%;
  animation: bounce 1s infinite ease-in-out;
}
.typing-bubble span:nth-child(2){ animation-delay:0.15s; }
.typing-bubble span:nth-child(3){ animation-delay:0.3s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0.6); opacity:0.6; }
  40% { transform: scale(1.2); opacity:1; }
}

/* ===== Offline Banner ===== */
#offlineBanner {
  border-bottom-left-radius: 15px;
  border-bottom-right-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  font-weight: 600;
  letter-spacing: 0.5px;
}
@keyframes slideDown {
  0% { transform: translateY(-120%); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}
#offlineBanner.show {
  animation: slideDown 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
}

</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
{% endblock %}
