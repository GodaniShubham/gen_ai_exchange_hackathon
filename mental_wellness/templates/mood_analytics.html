<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mood Analytics – Saharathi AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.0"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
                    colors: {
                        brand: {
                            50: "#e9fdf5", 100: "#c8f8e6", 200: "#9df0d3", 300: "#6de6be", 400: "#42d6a7",
                            500: "#1cc88a", 600: "#13a573", 700: "#0f845e", 800: "#0b6549", 900: "#084f3a",
                        },
                    },
                    boxShadow: { mnc: "0 10px 30px rgba(0,0,0,.25)" },
                    animation: {
                        pulse: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        gradient: 'gradient 3s ease infinite',
                    },
                    keyframes: {
                        pulse: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: .5 },
                        },
                        gradient: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' },
                        },
                    },
                    backgroundSize: {
                        '200': '200% 200%',
                    },
                },
            },
        };
    </script>
    <style>
        html, body { scroll-behavior: smooth; background-color: #0b1320; color: white; }
        .chart-container { position: relative; height: 400px; width: 100%; background: rgba(255,255,255,0.05); border-radius: 1rem; padding: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .suggestion-card { background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(28,200,138,0.05)); border: 1px solid rgba(28,200,138,0.2); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; transition: all 0.3s ease; }
        .suggestion-card:hover { border-color: rgba(28,200,138,0.5); transform: translateY(-4px); box-shadow: 0 8px 24px rgba(28,200,138,0.3); }
        .tab-active { background-color: #1cc88a; color: #0a1713; box-shadow: 0 2px 8px rgba(28,200,138,0.4); }
        button.rounded-full:hover { background-color: #13a573 !important; color: #0a1713 !important; transition: background-color 0.3s ease, color 0.3s ease; }
        .heatmap { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 0.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 1rem; }
        .heatmap-cell { aspect-ratio: 1; border-radius: 0.5rem; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .heatmap-cell:hover { transform: scale(1.15); z-index: 10; box-shadow: 0 4px 12px rgba(255,255,255,0.2); }
        .heatmap-cell::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .heatmap-cell:hover::after { opacity: 1; }
        .streak-badge { background: linear-gradient(135deg, #1cc88a, #10b981); border-radius: 9999px; padding: 0.5rem 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(28,200,138,0.3); animation: pulse 2s infinite; }
        .gradient-bg { background: linear-gradient(120deg, #0b1320, #1b2a49, #0d1f2d); background-size: 200% 200%; animation: gradient 15s ease infinite; }
        .icon-btn { display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="font-sans gradient-bg">
    <header class="py-6 px-6 lg:px-8 sticky top-0 z-50 bg-[#0b1320]/95 backdrop-blur-md border-b border-white/10">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <a href="index.html" class="p-2 rounded-full bg-white/5 hover:bg-white/10 transition">
                <svg viewBox="0 0 24 24" class="h-5 w-5 text-brand-300" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </a>
            <h1 class="text-3xl font-bold">Mood Analytics</h1>
            <button id="exportBtn" class="px-4 py-2 rounded-lg bg-brand-500 text-[#0a1713] font-semibold hover:opacity-90 transition-all hover:shadow-lg">Export Insights</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 lg:px-8 py-12 space-y-16">
        <!-- Streak Overview -->
        <section class="text-center p-6 rounded-2xl bg-white/5 border border-white/10 shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Your Mood Streaks</h2>
            <div class="flex justify-center gap-8">
                <div class="streak-badge"><i class="fas fa-fire text-orange-400"></i> Current Streak: <span id="currentStreak">0</span> days</div>
                <div class="streak-badge"><i class="fas fa-trophy text-yellow-400"></i> Longest Streak: <span id="longestStreak">0</span> days</div>
            </div>
        </section>

        <!-- View Toggle -->
        <div class="flex flex-wrap justify-center gap-4">
            <button id="dailyBtn" class="icon-btn px-6 py-3 rounded-full bg-brand-500 text-[#0a1713] font-semibold tab-active shadow-md hover:shadow-lg transition-shadow"><i class="fas fa-calendar-day"></i> Daily View</button>
            <button id="weeklyBtn" class="icon-btn px-6 py-3 rounded-full bg-white/5 border border-white/10 text-white shadow-md hover:shadow-lg transition-shadow"><i class="fas fa-calendar-week"></i> Weekly Summary</button>
            <button id="monthlyBtn" class="icon-btn px-6 py-3 rounded-full bg-white/5 border border-white/10 text-white shadow-md hover:shadow-lg transition-shadow"><i class="fas fa-calendar-alt"></i> Monthly Trends</button>
            <button id="heatmapBtn" class="icon-btn px-6 py-3 rounded-full bg-white/5 border border-white/10 text-white shadow-md hover:shadow-lg transition-shadow"><i class="fas fa-th"></i> Mood Heatmap</button>
        </div>

        <!-- Chart Section -->
        <div class="chart-container shadow-xl">
            <canvas id="moodChart"></canvas>
        </div>

        <!-- AI Insights -->
        <section class="p-6 rounded-2xl bg-white/5 border border-white/10 shadow-xl">
            <h2 class="text-2xl font-bold mb-6">AI-Powered Insights & Recommendations</h2>
            <div id="suggestions" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Advanced Trend Analysis -->
        <section class="p-6 rounded-2xl bg-white/5 border border-white/10 shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Advanced Trend Analysis</h2>
            <p id="trendSummary" class="text-white/80 mb-6 text-center font-medium"></p>
            <div class="h-64">
                <canvas id="trendChart"></canvas>
            </div>
        </section>
    </main>

    <script>
        const { DateTime } = luxon;
        const moods = JSON.parse(localStorage.getItem('moods')) || [];
        let chartInstance = null;
        let trendChartInstance = null;
        let currentMode = 'daily';

        const moodLevels = ["Stressed", "Sad", "Okay", "Good", "Great"];
        const moodColors = ['#ef4444', '#f59e0b', '#eab308', '#22c55e', '#10b981'];

        function groupBy(data, keyFn) {
            return data.reduce((acc, item) => {
                const key = keyFn(item);
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});
        }

        function calculateAverage(group) {
            if (group.length === 0) return 0;
            const sum = group.reduce((acc, m) => acc + m.level, 0);
            return sum / group.length;
        }

        function calculateStreaks() {
            if (moods.length === 0) return { current: 0, longest: 0 };

            const sortedMoods = [...moods].sort((a, b) => new Date(a.date) - new Date(b.date));
            let currentStreak = 0;
            let longestStreak = 0;
            let prevDate = null;
            let streak = 1;

            for (const mood of sortedMoods) {
                const currentDate = DateTime.fromISO(mood.date).startOf('day');
                if (prevDate && currentDate.diff(prevDate, 'days').days === 1) {
                    streak++;
                } else {
                    longestStreak = Math.max(longestStreak, streak);
                    streak = 1;
                }
                prevDate = currentDate;
            }
            longestStreak = Math.max(longestStreak, streak);
            // Assume current streak is from last log to today if consecutive
            const lastDate = DateTime.fromISO(sortedMoods[sortedMoods.length - 1].date).startOf('day');
            const today = DateTime.now().startOf('day');
            currentStreak = today.diff(lastDate, 'days').days <= 1 ? streak : 0;

            return { current: currentStreak, longest: longestStreak };
        }

        function renderChart(mode) {
            const ctx = document.getElementById('moodChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            let labels = [];
            let data = [];
            let type = 'line';
            let backgroundColor = moodColors;
            let borderColor = '#1cc88a';
            let options = {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 4,
                        ticks: {
                            stepSize: 1,
                            callback: value => moodLevels[value]
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: { grid: { color: 'rgba(255,255,255,0.1)' } }
                },
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    zoom: {
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' },
                        pan: { enabled: true, mode: 'xy' }
                    },
                    legend: { labels: { color: 'white' } },
                    tooltip: { backgroundColor: '#1f2937', titleColor: '#1cc88a', bodyColor: 'white' }
                },
                elements: { line: { tension: 0.4 }, point: { radius: 4, hoverRadius: 6 } }
            };

            const parsedMoods = moods.map(m => ({ ...m, date: DateTime.fromISO(m.date) })).sort((a,b) => a.date - b.date);

            if (mode === 'daily') {
                labels = parsedMoods.map(m => m.date.toLocaleString(DateTime.DATE_MED));
                data = parsedMoods.map(m => m.level);
                options.scales.x.type = 'time';
                options.scales.x.time = { unit: 'day' };
            } else if (mode === 'weekly') {
                type = 'bar';
                const weeks = groupBy(parsedMoods, m => m.date.weekYear + '-' + m.date.weekNumber);
                const sortedKeys = Object.keys(weeks).sort();
                labels = sortedKeys.map(w => {
                    const [year, week] = w.split('-').map(Number);
                    const startDate = DateTime.fromObject({ weekYear: year, weekNumber: week, weekday: 1 });
                    return `Week ${week} (${startDate.toFormat('MMM dd')})`;
                });
                data = sortedKeys.map(key => calculateAverage(weeks[key]));
                backgroundColor = data.map(avg => moodColors[Math.round(avg)]);
            } else if (mode === 'monthly') {
                type = 'bar';
                const months = groupBy(parsedMoods, m => m.date.toFormat('yyyy-MM'));
                labels = Object.keys(months).sort().map(k => DateTime.fromFormat(k, 'yyyy-MM').toLocaleString({ month: 'long', year: 'numeric' }));
                data = Object.values(months).map(group => calculateAverage(group));
                backgroundColor = data.map(avg => moodColors[Math.round(avg)]);
                options.scales.x = { stacked: false };
            } else if (mode === 'heatmap') {
                type = 'matrix';
                const start = parsedMoods[0]?.date.minus({ days: parsedMoods[0].date.weekday - 1 }) || DateTime.now().minus({ months: 3 });
                const end = DateTime.now();
                const weeks = Math.ceil(end.diff(start, 'weeks').weeks);
                data = [];
                for (let w = 0; w < weeks; w++) {
                    for (let d = 1; d <= 7; d++) {
                        const date = start.plus({ weeks: w, days: d - 1 });
                        if (date > end) break;
                        const dayMoods = parsedMoods.filter(m => m.date.hasSame(date, 'day'));
                        const avg = calculateAverage(dayMoods);
                        data.push({ x: w, y: d, v: avg || 0, date: date.toLocaleString(DateTime.DATE_SHORT) });
                    }
                }
                options.scales.x = { type: 'linear', position: 'top', ticks: { callback: v => `Week ${v + 1}` } };
                options.scales.y = { type: 'linear', reverse: true, ticks: { callback: v => ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][v - 1] } };
                options.plugins.tooltip = {
                    callbacks: {
                        title: item => item[0].raw.date,
                        label: item => `Mood: ${moodLevels[Math.round(item.raw.v)] || 'No data'} (${item.raw.v.toFixed(1)})`
                    }
                };
                options.elements = { matrix: { backgroundColor: (context) => moodColors[Math.round(context.raw.v)] || 'rgba(255,255,255,0.1)' } };
            }

            chartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Mood Level',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        fill: mode === 'daily',
                        pointBackgroundColor: mode === 'daily' ? moodColors : undefined,
                    }]
                },
                options: options
            });
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();

            const parsedMoods = moods.map(m => ({ x: DateTime.fromISO(m.date).toJSDate(), y: m.level }));
            parsedMoods.sort((a, b) => a.x - b.x);

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Mood Trend',
                        data: parsedMoods,
                        borderColor: '#1cc88a',
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: parsedMoods.map(p => moodColors[p.y]),
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { min: 0, max: 4, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Calculate overall trend
            if (parsedMoods.length > 1) {
                const first = parsedMoods[0].y;
                const last = parsedMoods[parsedMoods.length - 1].y;
                const trend = last - first > 0 ? 'improving' : last - first < 0 ? 'declining' : 'stable';
                document.getElementById('trendSummary').textContent = `Your overall mood trend is ${trend}. Average mood: ${calculateAverage(moods.map(m => ({level: m.level}))).toFixed(2)} / 4`;
            } else {
                document.getElementById('trendSummary').textContent = 'Log more moods to see trend analysis.';
            }
        }

        function updateStreaks() {
            const streaks = calculateStreaks();
            document.getElementById('currentStreak').textContent = streaks.current;
            document.getElementById('longestStreak').textContent = streaks.longest;
        }

        function generateSuggestions() {
            const suggestionsEl = document.getElementById('suggestions');
            suggestionsEl.innerHTML = '';

            if (moods.length < 5) {
                addSuggestion('Log more moods to unlock advanced AI insights, personalized recommendations, and pattern detection.');
                return;
            }

            // Enhanced suggestions without emojis
            const hours = groupBy(moods, m => new Date(m.date).getHours());
            const eveningHours = [18,19,20,21];
            const eveningMoods = eveningHours.flatMap(h => hours[h] || []);
            if (eveningMoods.length > 3 && calculateAverage(eveningMoods) < 2.5) {
                addSuggestion('AI Detected: Evening anxiety pattern (average score ' + calculateAverage(eveningMoods).toFixed(1) + '). Pro Tip: Schedule our guided breathing session at sunset – users report 20% mood lift.');
            }

            const days = groupBy(moods, m => new Date(m.date).getDay());
            const weekendMoods = [...(days[0] || []), ...(days[6] || [])];
            const weekdayMoods = moods.filter(m => ![0,6].includes(new Date(m.date).getDay()));
            if (weekendMoods.length > 2 && weekdayMoods.length > 5 && calculateAverage(weekendMoods) > calculateAverage(weekdayMoods) + 1) {
                addSuggestion('AI Pattern: Weekend mood boost detected (+' + (calculateAverage(weekendMoods) - calculateAverage(weekdayMoods)).toFixed(1) + ' points). Suggestion: Micro-dose joy – add 15-min hobby breaks to weekdays for sustained balance.');
            }

            const sortedMoods = [...moods].sort((a,b) => new Date(a.date) - new Date(b.date));
            let lowStreak = 0;
            for (let i = sortedMoods.length - 1; i >= 0; i--) {
                if (sortedMoods[i].level < 2) lowStreak++;
                else break;
            }
            if (lowStreak >= 3) {
                addSuggestion(`AI Alert: ${lowStreak}-day low mood streak. Break it with targeted actions: Start our daily affirmation challenge or journal gratitude – 70% of users see improvement in 3 days.`);
            }

            const anxietyKeywords = ['anxious', 'stress', 'worried', 'overwhelmed'];
            const anxiousNotes = moods.filter(m => anxietyKeywords.some(k => m.notes.toLowerCase().includes(k)));
            if (anxiousNotes.length > moods.length * 0.3) {
                addSuggestion('AI Note Analysis: Anxiety themes in ' + Math.round((anxiousNotes.length / moods.length) * 100) + '% of entries. Recommendation: Track triggers in notes; try cognitive reframing module. If ongoing, consider professional consultation.');
            }

            const avgMood = calculateAverage(moods.map(m => ({level: m.level})));
            if (avgMood < 2.5) {
                addSuggestion(`AI Overview: Mood average ${avgMood.toFixed(1)}/4 (room for growth). Personalized Plan: Set weekly goals in app, enable reminders for mood-boosting activities like our quick meditations.`);
            } else if (avgMood > 3.5) {
                addSuggestion(`AI Kudos: Stellar average of ${avgMood.toFixed(1)}/4! Maintain Momentum: Share successful strategies in notes to build your personal wellness playbook.`);
            }

            function addSuggestion(text) {
                const div = document.createElement('div');
                div.className = 'suggestion-card';
                div.innerHTML = `<p class="text-white">${text}</p>`;
                suggestionsEl.appendChild(div);
            }
        }

        // Button listeners
        ['daily', 'weekly', 'monthly', 'heatmap'].forEach(mode => {
            document.getElementById(mode + 'Btn').addEventListener('click', () => switchMode(mode));
        });

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('button.rounded-full').forEach(btn => {
                btn.classList.remove('tab-active');
            });
            document.getElementById(mode + 'Btn').classList.add('tab-active');
            renderChart(mode);
        }

        document.getElementById('exportBtn').addEventListener('click', () => {
            const csv = 'Date,Level,Notes\n' + moods.map(m => `${m.date},${m.level},"${m.notes.replace(/"/g, '""')}"`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mood_analytics_data.csv';
            a.click();
        });

        // Initial render
        updateStreaks();
        switchMode('daily');
        generateSuggestions();
        renderTrendChart();
    </script>
</body>
</html>