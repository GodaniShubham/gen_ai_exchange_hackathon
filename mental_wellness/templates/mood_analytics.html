<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mood Analytics – Saharathi AI</title>

  <style>
    :root {
      --bg-0: #000000;
      --bg-1: #0b0b0d;
      --bg-2: #111114;
      --bg-3: #16161a;
      --txt-0: #ffffff;
      --txt-1: #d1d1d6;
      --txt-2: #8e8e93;
      --stroke: rgba(255, 255, 255, 0.06);
      --shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
      --accent: #0a84ff;
      --accent-2: #64d2ff;
      --success: #30d158;
      --warning: #ffd60a;
      --danger: #ff453a;
    }

    html,
    body {
      font-size: 14px;
      margin: 0;
      padding: 0;
      color: var(--txt-0);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, system-ui, sans-serif;
      letter-spacing: -0.01em;
      line-height: 1.55;
      width: 100%;
      max-width: 100%;
      overflow-x: clip;
      position: relative;
      background: var(--bg-0);
    }

    /* background overlays */
    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
    }

    body::before {
      background: radial-gradient(circle at top right, rgba(10, 132, 255, 0.12) 0, transparent 70%);
    }

    body::after {
      background:
        radial-gradient(circle at bottom left, rgba(100, 210, 255, 0.12) 0, transparent 70%),
        linear-gradient(180deg, var(--bg-1), var(--bg-0));
    }

    img,
    canvas,
    svg {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .nav {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(160%) blur(14px);
      background: color-mix(in srgb, var(--bg-1) 88%, transparent);
      border-bottom: 1px solid var(--stroke);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
    }

    .nav-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .title {
      font-size: clamp(18px, 2.5vw, 24px);
      font-weight: 700;
    }

    .btn {
      border-radius: 9999px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, #1a1a1e, #101014);
      color: var(--txt-0);
      transition: all 0.25s ease;
    }

    .btn-primary {
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 85%, #1c1c1f 15%), #0a345f);
      border: 1px solid color-mix(in srgb, var(--accent) 45%, #000 55%);
      box-shadow: 0 6px 20px rgba(10, 132, 255, 0.35);
    }

    .btn-primary:hover {
      filter: brightness(1.08);
      box-shadow: 0 10px 28px rgba(10, 132, 255, 0.45);
    }

    .container {
      max-width: 1120px;
      margin: 32px auto 0;
      padding: 0 16px;
      box-sizing: border-box;
    }

    .stack {
      display: grid;
      gap: 48px;
    }

    .card {
      background: linear-gradient(180deg, color-mix(in srgb, var(--bg-3) 92%, transparent), color-mix(in srgb, var(--bg-2) 92%, transparent));
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--stroke);
    }

    .kicker {
      color: var(--txt-2);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .14em;
    }

    h2 {
      font-size: clamp(18px, 2.5vw, 22px);
      margin: 8px 0 14px;
      font-weight: 700;
    }

    .subtle {
      color: var(--txt-1);
      text-decoration: none;
    }

    .streaks {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .streak {
      padding: 10px 18px;
      border-radius: 9999px;
      background: linear-gradient(180deg, #151519, #0f0f13);
      border: 1px solid var(--stroke);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
    }

    .streak .num {
      font-size: 18px;
      font-weight: 700;
    }

    .streak .lbl {
      font-size: 11px;
      color: var(--txt-2);
    }

    .chart-wrap {
      height: 340px;
      border-radius: 14px;
      padding: 12px;
      background: #0f0f13;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }

    .suggestion-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .suggestion {
      background: linear-gradient(180deg, #121216, #0f0f13);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      font-size: 13px;
      padding: 12px;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .tab {
      padding: 8px 16px;
      border-radius: 9999px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, #131317, #0f0f13);
      font-size: 13px;
      color: var(--txt-1);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03),
              0 2px 6px rgba(0, 0, 0, 0.25); 
    }

    .tab.active {
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 25%, #111114 75%), #0e1420);
      color: #fff;
      border-color: color-mix(in srgb, var(--accent) 40%, #000 60%);
      box-shadow: 0 2px 8px rgba(10, 132, 255, 0.18); 
    }

    .spacer {
      height: 50px;
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.0"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
</head>

<body>
  <nav class="nav">
    <div class="nav-inner">
      <a href="{% url 'index' %}" class="subtle">← Back</a>
      <div class="title">Mood Analytics</div>
      <button id="exportBtn" class="btn btn-primary">Export</button>
    </div>
  </nav>

  <main class="container">
    <div class="stack">

      <!-- Mood Streaks -->
      <section class="card">
        <div class="kicker">Overview</div>
        <h2>Your Mood Streaks</h2>
        <div class="streaks">
          <div class="streak">
            <div class="num" id="currentStreak">0</div>
            <div class="lbl">Current Streak</div>
          </div>
          <div class="streak">
            <div class="num" id="longestStreak">0</div>
            <div class="lbl">Longest Streak</div>
          </div>
        </div>
      </section>

      <!-- Views -->
      <section class="card">
        <div class="kicker">Explore</div>
        <h2>Views</h2>
        <div class="tabs">
          <button id="dailyBtn" class="tab active"><i class="fa-solid fa-calendar-day"></i>&nbsp;Daily</button>
          <button id="weeklyBtn" class="tab"><i class="fa-solid fa-calendar-week"></i>&nbsp;Weekly</button>
          <button id="monthlyBtn" class="tab"><i class="fa-solid fa-calendar-alt"></i>&nbsp;Monthly</button>
          <button id="heatmapBtn" class="tab"><i class="fa-solid fa-table-cells"></i>&nbsp;Heatmap</button>
        </div>
        <div class="chart-wrap" style="margin-top:14px;">
          <canvas id="moodChart"></canvas>
        </div>
      </section>

      <!-- AI Insights -->
      <section class="card">
        <div class="kicker">Assistant</div>
        <h2>AI Insights</h2>
        <div id="suggestions" class="suggestion-grid"></div>
      </section>

      <!-- Advanced Trend -->
      <section class="card">
        <div class="kicker">Analysis</div>
        <h2>Advanced Trend</h2>
        <p id="trendSummary" class="subtle" style="text-align:center; margin-bottom: 12px;"></p>
        <div class="chart-wrap" style="height:320px;">
          <canvas id="trendChart"></canvas>
        </div>
      </section>

      <div class="spacer"></div>
    </div>
  </main>

  <script>
    // ===== Data & Utilities =====
    const { DateTime } = luxon;
    const moods = JSON.parse('{{ moods_json|safe|escapejs }}');

    let chartInstance = null;
    let trendChartInstance = null;
    let currentMode = 'daily';

    const moodLevels = ["Stressed", "Sad", "Okay", "Good", "Great"];
    const moodColors = ['#ff453a', '#ffd60a', '#ff9f0a', '#30d158', '#0a84ff'];

    function groupBy(data, keyFn) {
      return data.reduce((acc, item) => {
        const key = keyFn(item);
        if (!acc[key]) acc[key] = [];
        acc[key].push(item);
        return acc;
      }, {});
    }

    function calculateAverage(group) {
      if (!group || group.length === 0) return 0;
      const sum = group.reduce((acc, m) => acc + m.level, 0);
      return sum / group.length;
    }

    function calculateStreaks() {
      if (moods.length === 0) return { current: 0, longest: 0 };

      const sortedMoods = [...moods].sort((a, b) => new Date(a.date) - new Date(b.date));
      let longestStreak = 0;
      let prevDate = null;
      let streak = 1;

      for (const mood of sortedMoods) {
        const currentDate = DateTime.fromISO(mood.date).startOf('day');
        if (prevDate && currentDate.diff(prevDate, 'days').days === 1) {
          streak++;
        } else {
          longestStreak = Math.max(longestStreak, streak);
          streak = 1;
        }
        prevDate = currentDate;
      }
      longestStreak = Math.max(longestStreak, streak);

      const lastDate = DateTime.fromISO(sortedMoods[sortedMoods.length - 1].date).startOf('day');
      const today = DateTime.now().startOf('day');
      const currentStreak = today.diff(lastDate, 'days').days <= 1 ? streak : 0;

      return { current: currentStreak, longest: longestStreak };
    }

    // ===== Charts (unchanged) =====
    function baseChartOptions() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 700, easing: 'easeInOutQuart' },
        plugins: {
          legend: { labels: { color: '#e5e7eb', boxWidth: 10, boxHeight: 10, usePointStyle: true } },
          tooltip: {
            backgroundColor: '#0b0b0e',
            titleColor: '#fff', bodyColor: '#fff',
            borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1,
            padding: 10, displayColors: false
          },
          zoom: {
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' },
            pan: { enabled: true, mode: 'xy' }
          }
        },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#c7c7cc' } },
          y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#c7c7cc' } }
        },
        elements: { line: { tension: 0.32 }, point: { radius: 4, hoverRadius: 6 } }
      };
    }

    function renderChart(mode) {
      const ctx = document.getElementById('moodChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      let labels = [];
      let data = [];
      let type = 'line';
      let backgroundColor = moodColors;
      let borderColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#0a84ff';
      let options = baseChartOptions();

      const parsedMoods = moods.map(m => ({ ...m, date: DateTime.fromISO(m.date) })).sort((a, b) => a.date - b.date);

      if (mode === 'daily') {
        labels = parsedMoods.map(m => m.date.toJSDate());
        data = parsedMoods.map(m => m.level);
        options.scales.x.type = 'time';
        options.scales.x.time = { unit: 'day' };
        options.scales.y = {
          min: 0, max: 4,
          grid: { color: 'rgba(255,255,255,0.06)' },
          ticks: { stepSize: 1, color: '#c7c7cc', callback: v => moodLevels[v] }
        };
      }
      else if (mode === 'weekly') {
        type = 'bar';
        const weeks = groupBy(parsedMoods, m => m.date.weekYear + '-' + m.date.weekNumber);
        const sortedKeys = Object.keys(weeks).sort();
        labels = sortedKeys.map(w => {
          const [year, week] = w.split('-').map(Number);
          const startDate = DateTime.fromObject({ weekYear: year, weekNumber: week, weekday: 1 });
          return `Week ${week} (${startDate.toFormat('MMM dd')})`;
        });
        data = sortedKeys.map(key => calculateAverage(weeks[key]));
        backgroundColor = data.map(avg => moodColors[Math.round(avg)]);
        options.scales.y = { min: 0, max: 4, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { stepSize: 1, color: '#c7c7cc' } };
      }
      else if (mode === 'monthly') {
        type = 'bar';
        const months = groupBy(parsedMoods, m => m.date.toFormat('yyyy-MM'));
        const keys = Object.keys(months).sort();
        labels = keys.map(k => DateTime.fromFormat(k, 'yyyy-MM').toLocaleString({ month: 'long', year: 'numeric' }));
        data = keys.map(k => calculateAverage(months[k]));
        backgroundColor = data.map(avg => moodColors[Math.round(avg)]);
        options.scales.y = { min: 0, max: 4, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { stepSize: 1, color: '#c7c7cc' } };
      }
      else if (mode === 'heatmap') {
        type = 'matrix';
        const start = parsedMoods[0]?.date?.minus({ days: parsedMoods[0].date.weekday - 1 }) || DateTime.now().minus({ months: 3 });
        const end = DateTime.now();
        const weeks = Math.ceil(end.diff(start, 'weeks').weeks);
        data = [];
        for (let w = 0; w < weeks; w++) {
          for (let d = 1; d <= 7; d++) {
            const date = start.plus({ weeks: w, days: d - 1 });
            if (date > end) break;
            const dayMoods = parsedMoods.filter(m => m.date.hasSame(date, 'day'));
            const avg = calculateAverage(dayMoods);
            data.push({ x: w, y: d, v: avg || 0, date: date.toLocaleString(DateTime.DATE_SHORT) });
          }
        }
        options.scales = {
          x: { type: 'linear', position: 'top', grid: { display: false }, ticks: { color: '#c7c7cc', callback: v => `W${v + 1}` } },
          y: { type: 'linear', reverse: true, grid: { display: false }, ticks: { color: '#c7c7cc', callback: v => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][v-1] } }
        };
        options.plugins.tooltip = {
          backgroundColor: '#0b0b0e', titleColor: '#fff', bodyColor: '#fff', borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1,
          callbacks: {
            title: items => items[0].raw.date,
            label: item => `Mood: ${moodLevels[Math.round(item.raw.v)] || 'No data'} (${item.raw.v.toFixed(1)})`
          }
        };
        options.elements = {
          matrix: {
            width: ctx => ctx.chart.chartArea && ctx.chart.chartArea.width ? (ctx.chart.chartArea.width / Math.max(1, Math.ceil(data.length / 7))) - 2 : 18,
            height: ctx => ctx.chart.chartArea && ctx.chart.chartArea.height ? (ctx.chart.chartArea.height / 7) - 4 : 18,
            backgroundColor: c => moodColors[Math.round(c.raw.v)] || 'rgba(255,255,255,0.06)',
            borderColor: 'rgba(255,255,255,0.02)', borderWidth: 1
          }
        };
      }

      chartInstance = new Chart(ctx, {
        type,
        data: { labels, datasets: [{ label: 'Mood Level', data, backgroundColor, borderColor, borderWidth: 2, fill: mode==='daily', pointBackgroundColor: mode==='daily' ? moodColors : undefined }] },
        options
      });
    }

    function renderTrendChart(mode = 'daily') {
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChartInstance) trendChartInstance.destroy();

      let trendData = moods.map(m => ({ x: DateTime.fromISO(m.date).toJSDate(), y: m.level })).sort((a, b) => a.x - b.x);
      if (mode === 'weekly') {
        const weeks = groupBy(moods, m => DateTime.fromISO(m.date).weekYear + '-' + DateTime.fromISO(m.date).weekNumber);
        trendData = Object.keys(weeks).sort().map(key => {
          const [year, week] = key.split('-').map(Number);
          const startDate = DateTime.fromObject({ weekYear: year, weekNumber: week, weekday: 1 }).toJSDate();
          return { x: startDate, y: calculateAverage(weeks[key]) };
        });
      } else if (mode === 'monthly') {
        const months = groupBy(moods, m => DateTime.fromISO(m.date).toFormat('yyyy-MM'));
        trendData = Object.keys(months).sort().map(key => {
          const date = DateTime.fromFormat(key, 'yyyy-MM').toJSDate();
          return { x: date, y: calculateAverage(months[key]) };
        });
      } else if (mode === 'heatmap') {
        const start = DateTime.fromISO(moods[0]?.date || DateTime.now().toISO()).minus({ days: DateTime.fromISO(moods[0]?.date || DateTime.now().toISO()).weekday - 1 });
        const end = DateTime.now();
        const weeks = Math.ceil(end.diff(start, 'weeks').weeks);
        trendData = [];
        for (let w = 0; w < weeks; w++) {
          for (let d = 1; d <= 7; d++) {
            const date = start.plus({ weeks: w, days: d - 1 });
            if (date > end) break;
            const dayMoods = moods.filter(m => DateTime.fromISO(m.date).hasSame(date, 'day'));
            const avg = calculateAverage(dayMoods);
            trendData.push({ x: date.toJSDate(), y: avg || 0 });
          }
        }
      }

      trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Mood Trend',
            data: trendData,
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#0a84ff',
            borderWidth: 2,
            tension: 0.32,
            pointRadius: 3,
            pointBackgroundColor: trendData.map(p => moodColors[Math.round(p.y)]),
            pointHoverRadius: 6
          }]
        },
        options: {
          ...baseChartOptions(),
          plugins: { legend: { display: false } },
          scales: {
            x: { type: 'time', time: { unit: mode === 'daily' ? 'day' : mode === 'weekly' ? 'week' : 'month' }, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#c7c7cc' } },
            y: { min: 0, max: 4, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#c7c7cc' } }
          }
        }
      });

      const avg = calculateAverage(trendData.map(d => ({ level: d.y })));
      if (trendData.length > 1) {
        const first = trendData[0].y;
        const last = trendData[trendData.length - 1].y;
        const delta = last - first;
        const trend = delta > 0 ? 'improving' : delta < 0 ? 'declining' : 'stable';
        document.getElementById('trendSummary').textContent = `Your overall ${mode} mood trend is ${trend}. Average mood: ${avg.toFixed(2)} / 4`;
      } else {
        document.getElementById('trendSummary').textContent = `Log more moods to see ${mode} trend analysis.`;
      }
    }

    // ===== AI Insights =====
    async function fetchAIInsights(mode = 'daily') {
      const suggestionsEl = document.getElementById('suggestions');
      suggestionsEl.innerHTML = `<div class="suggestion">Analyzing your moods… ⏳</div>`;

      try {
        const res = await fetch(`{% url 'mood_insights' %}?mode=${mode}`);
        const data = await res.json();
        suggestionsEl.innerHTML = '';

        const div = document.createElement('div');
        div.className = 'suggestion';
        div.innerHTML = `<p class="subtle" style="color:#eaeaec; line-height:1.6;">${data.insights}</p>`;
        suggestionsEl.appendChild(div);
      } catch (err) {
        console.error('AI Insights fetch failed:', err);
        suggestionsEl.innerHTML = `<div class="suggestion">⚠️ Failed to load AI insights.</div>`;
      }
    }

    // ===== Tabs & Export =====
    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.toggle('active', btn.id === mode + 'Btn');
        btn.setAttribute('aria-selected', btn.id === mode + 'Btn' ? 'true' : 'false');
      });
      renderChart(mode);
      fetchAIInsights(mode); // Re-fetch AI insights for the mode
      renderTrendChart(mode); // Update trend chart for the mode
    }

    document.getElementById('dailyBtn').addEventListener('click', () => switchMode('daily'));
    document.getElementById('weeklyBtn').addEventListener('click', () => switchMode('weekly'));
    document.getElementById('monthlyBtn').addEventListener('click', () => switchMode('monthly'));
    document.getElementById('heatmapBtn').addEventListener('click', () => switchMode('heatmap'));

    document.getElementById('exportBtn').addEventListener('click', () => {
      const csv = 'Date,Level,Notes\n' + moods.map(m => `${m.date},${m.level},"${(m.notes || '').replace(/"/g, '""')}"`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'mood_analytics_data.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ===== Initial Render =====
    function updateStreaks() {
      const { current, longest } = calculateStreaks();
      document.getElementById('currentStreak').textContent = current;
      document.getElementById('longestStreak').textContent = longest;
    }

    updateStreaks();
    switchMode('daily');
  </script>

</body>

</html>